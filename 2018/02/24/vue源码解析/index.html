<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>vue源码解析 | DogJun&#39;s Blog</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="最近项目没有那么忙，想着研究下vue源码，下周给团队的成员share一下，帮助大家更好的做项目，把总结的笔记记录一下。">
<meta name="keywords" content="vue">
<meta property="og:type" content="article">
<meta property="og:title" content="vue源码解析">
<meta property="og:url" content="http://yoursite.com/2018/02/24/vue源码解析/index.html">
<meta property="og:site_name" content="DogJun&#39;s Blog">
<meta property="og:description" content="最近项目没有那么忙，想着研究下vue源码，下周给团队的成员share一下，帮助大家更好的做项目，把总结的笔记记录一下。">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="http://p1cbbowoo.bkt.clouddn.com/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202018-04-01%20%E4%B8%8B%E5%8D%8810.39.47.png">
<meta property="og:image" content="http://p1cbbowoo.bkt.clouddn.com/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202018-04-01%20%E4%B8%8B%E5%8D%8810.50.32.png">
<meta property="og:image" content="http://p1cbbowoo.bkt.clouddn.com/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202018-04-01%20%E4%B8%8B%E5%8D%8810.49.57.png">
<meta property="og:image" content="http://p1cbbowoo.bkt.clouddn.com/%E5%BE%AE%E4%BF%A1%E5%9B%BE%E7%89%87_20180402153924.png">
<meta property="og:image" content="http://p1cbbowoo.bkt.clouddn.com/%E5%BE%AE%E4%BF%A1%E5%9B%BE%E7%89%87_20180402153929.png">
<meta property="og:image" content="http://p1cbbowoo.bkt.clouddn.com/%E5%BE%AE%E4%BF%A1%E5%9B%BE%E7%89%87_20180402162223.png">
<meta property="og:image" content="http://p1cbbowoo.bkt.clouddn.com/%E5%BE%AE%E4%BF%A1%E5%9B%BE%E7%89%87_20180402164259.png">
<meta property="og:image" content="http://p1cbbowoo.bkt.clouddn.com/%E5%BE%AE%E4%BF%A1%E5%9B%BE%E7%89%87_20180402164303.png">
<meta property="og:image" content="http://p1cbbowoo.bkt.clouddn.com/%E5%BE%AE%E4%BF%A1%E5%9B%BE%E7%89%87_20180402171141.png">
<meta property="og:image" content="http://p1cbbowoo.bkt.clouddn.com/%E5%BE%AE%E4%BF%A1%E5%9B%BE%E7%89%87_20180402171147.png">
<meta property="og:image" content="http://p1cbbowoo.bkt.clouddn.com/%E5%BE%AE%E4%BF%A1%E5%9B%BE%E7%89%87_20180402171153.png">
<meta property="og:image" content="http://p1cbbowoo.bkt.clouddn.com/%E5%BE%AE%E4%BF%A1%E5%9B%BE%E7%89%87_20180402171157.png">
<meta property="og:image" content="http://p1cbbowoo.bkt.clouddn.com/%E5%BE%AE%E4%BF%A1%E5%9B%BE%E7%89%87_20180402171637.png">
<meta property="og:updated_time" content="2018-07-19T08:52:42.594Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="vue源码解析">
<meta name="twitter:description" content="最近项目没有那么忙，想着研究下vue源码，下周给团队的成员share一下，帮助大家更好的做项目，把总结的笔记记录一下。">
<meta name="twitter:image" content="http://p1cbbowoo.bkt.clouddn.com/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202018-04-01%20%E4%B8%8B%E5%8D%8810.39.47.png">
  
    <link rel="alternate" href="/atom.xml" title="DogJun&#39;s Blog" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css">
  

</head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">DogJun&#39;s Blog</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://yoursite.com"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-vue源码解析" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/02/24/vue源码解析/" class="article-date">
  <time datetime="2018-02-24T15:35:17.000Z" itemprop="datePublished">2018-02-24</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/前端/">前端</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      vue源码解析
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>最近项目没有那么忙，想着研究下vue源码，下周给团队的成员share一下，帮助大家更好的做项目，把总结的笔记记录一下。</p>
<h2 id=""><a href="#" class="headerlink" title=""></a><a id="more"></a></h2><h1 id="vue架构概览"><a href="#vue架构概览" class="headerlink" title="vue架构概览"></a>vue架构概览</h1><p><img src="http://p1cbbowoo.bkt.clouddn.com/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202018-04-01%20%E4%B8%8B%E5%8D%8810.39.47.png" alt="image"></p>
<ul>
<li>/complier目录是编译模板</li>
<li>/core目录是Vue.js的核心</li>
<li>/entries目录是生产打包的入口</li>
<li>/platforms目录是针对核心模块的平台模块</li>
<li>/server目录是处理服务器端渲染</li>
<li>/sfc目录是处理单文件.vue</li>
<li>/shared目录提供全局用到的工具函数</li>
</ul>
<p><img src="http://p1cbbowoo.bkt.clouddn.com/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202018-04-01%20%E4%B8%8B%E5%8D%8810.50.32.png" alt="image"></p>
<ul>
<li>compents 模板编译的代码</li>
<li>global-api 最上层的文件接口</li>
<li>instance 生命周期</li>
<li>observer 数据收集与订阅</li>
<li>util 常用工具方法类</li>
<li>vdom 虚拟dom</li>
</ul>
<p>结论: Vue.js 的组成是由 core + 对应的 ‘平台’ 补充代码构成(独立构建和运行时构建 只是 platforms 下 web 平台的两种选择)。<br><img src="http://p1cbbowoo.bkt.clouddn.com/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202018-04-01%20%E4%B8%8B%E5%8D%8810.49.57.png" alt="image"></p>
<h1 id="双向数据绑定"><a href="#双向数据绑定" class="headerlink" title="双向数据绑定"></a>双向数据绑定</h1><h2 id="双向绑定（响应式）所涉及到的技术"><a href="#双向绑定（响应式）所涉及到的技术" class="headerlink" title="双向绑定（响应式）所涉及到的技术"></a>双向绑定（响应式）所涉及到的技术</h2><ul>
<li>Object.defineProperty</li>
<li>Observer</li>
<li>Watcher</li>
<li>Dep</li>
<li>Directive</li>
</ul>
<h3 id="Object-defineProperty"><a href="#Object-defineProperty" class="headerlink" title="Object.defineProperty"></a>Object.defineProperty</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> obj = &#123;&#125;</div><div class="line"><span class="keyword">var</span> a</div><div class="line"><span class="built_in">Object</span>.defineProperty(obj, <span class="string">'a'</span>, &#123;</div><div class="line">    get: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</div><div class="line">        <span class="built_in">console</span>.log(<span class="string">'get val'</span>)</div><div class="line">        <span class="keyword">return</span> a</div><div class="line">    &#125;,</div><div class="line">    set: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</div><div class="line">        <span class="built_in">console</span>.log(<span class="string">'set val:'</span> + newVal)</div><div class="line">        a = newVal</div><div class="line">    &#125;</div><div class="line">&#125;)</div><div class="line">obj.a <span class="comment">// get val</span></div><div class="line">obj.a = <span class="string">'111'</span> <span class="comment">// set val: 111</span></div></pre></td></tr></table></figure>
<p>注：vue不支持IE9以下，是因为浏览器不支持Object.defineProperty，而这是vue核心利用的技术，如果想要向下兼容，则需要使用VBScript，VBbScript很早就有class的实现，这样就能拥有get和set方法。还有就是，很早的时候，一些浏览器拥有 （<strong>defineGetter</strong>）和 <strong>defineSetter</strong> 方法，来模拟set和get，来实现双向数据绑定。</p>
<h3 id="Observer"><a href="#Observer" class="headerlink" title="Observer"></a>Observer</h3><p>观察者模式是软件设计模式的一种。在此种模式中，一个目标对象管理所有相依于它的观察者对象，并且在它本身的状态改变时主动发出通知。这通常透过呼叫各观察者所提供的 方法来实现。此种模式通常被用来实时事件处理系统。  订阅者模式涉及三个对象:发布者、主题对象、订阅者，三个对象间的是一对多的关系，每当主题对象状态发生改变时，其相关依赖对象都会得到通知，并被自动更新。看一个简 单的示例:<br><figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// jquery经典实现</span></div><div class="line">(<span class="function"><span class="keyword">function</span> (<span class="params">$</span>) </span>&#123;</div><div class="line">    <span class="keyword">var</span> o = $(&#123;&#125;)</div><div class="line">    $.subscribe = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</div><div class="line">        o.subscribe = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</div><div class="line">            o.on.apply(o, <span class="built_in">arguments</span>)</div><div class="line">        &#125;</div><div class="line">        o.unsubscribe = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</div><div class="line">            o.off.apply(o, <span class="built_in">arguments</span>)</div><div class="line">        &#125;</div><div class="line">        o.publish = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</div><div class="line">            o.trigger.apply(o, <span class="built_in">arguments</span>)</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;)(jQuery)</div><div class="line"></div><div class="line"><span class="comment">// 订阅</span></div><div class="line">$.subscribe(<span class="string">'/some/topic'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">e,a,b,c</span>) </span>&#123;</div><div class="line">    <span class="built_in">console</span>.log(a + b + c)</div><div class="line">&#125;)</div><div class="line"><span class="comment">// 发布</span></div><div class="line">$.publish(<span class="string">'some/topic'</span>, [<span class="string">'a'</span>, <span class="string">'b'</span>, <span class="string">'c'</span>]) <span class="comment">// 输出abc</span></div><div class="line"><span class="comment">// 退订</span></div><div class="line">$.unsubscribe(<span class="string">'some/topic'</span>)</div></pre></td></tr></table></figure></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 主题对象</span></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">Dep</span> (<span class="params"></span>) </span>&#123;</div><div class="line">    <span class="keyword">this</span>.subs = [] <span class="comment">// 订阅列表</span></div><div class="line">&#125;</div><div class="line"><span class="comment">// 主题对象通知订阅者</span></div><div class="line">Dep.prototype.notify = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</div><div class="line">    <span class="comment">// 遍历所有的订阅者，执行订阅者提供的更新方法</span></div><div class="line">    <span class="keyword">this</span>.subs.forEach(<span class="function"><span class="keyword">function</span> (<span class="params">sub</span>) </span>&#123;</div><div class="line">        sub.update()</div><div class="line">    &#125;)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// 订阅者</span></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">Sub</span> (<span class="params">x</span>) </span>&#123;</div><div class="line">    <span class="keyword">this</span>.x = x</div><div class="line">&#125;</div><div class="line"><span class="comment">// 订阅者更新</span></div><div class="line">Sub.prototype.update = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</div><div class="line">    <span class="keyword">this</span>.x = <span class="keyword">this</span>.x + <span class="number">1</span></div><div class="line">    <span class="built_in">console</span>.log(<span class="keyword">this</span>.x)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// 发布者</span></div><div class="line"><span class="keyword">var</span> pub = &#123;</div><div class="line">    publish: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</div><div class="line">        dep.notify()</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"> </div><div class="line"><span class="keyword">var</span> dep = <span class="keyword">new</span> Dep() <span class="comment">// 主题对象实例</span></div><div class="line">dep.subs.push(<span class="keyword">new</span> Sub(<span class="number">1</span>), <span class="keyword">new</span> Sub(<span class="number">2</span>)) <span class="comment">// 新增两个订阅者</span></div><div class="line">pub.publish() <span class="comment">// 发布者发布更新</span></div></pre></td></tr></table></figure>
<p>Observer会观察两种类型的数据，Object 与 Array</p>
<ul>
<li>src/core/observer/index.js</li>
<li>src/core/observer/array.js</li>
</ul>
<p>对于Array类型的数据，由于 JavaScript 的限制，Vue 不能检测变化,会先重写操作数组的原型方法，重写后能达到两个目的：</p>
<ul>
<li>当数组发生变化时，触发 notify</li>
<li>如果是 push，unshift，splice这些添加新元素的操作，则会使用observer观察新添加的数据<br>重写完原型方法后，遍历拿到数组中的每个数据，使用observer观察它</li>
</ul>
<p>而对于Object类型的数据，则遍历它的每个key，使用 defineProperty 设置 getter 和setter，当触发getter的时候，observer则开始收集依赖，而触发setter的时候，observe 则触发notify。</p>
<h3 id="Watcher"><a href="#Watcher" class="headerlink" title="Watcher"></a>Watcher</h3><p>src/core/observer/watcher.js<br>Watcher 是将模板和 Observer对象结合在一起的纽带。Watcher 是订阅者模式中的订阅者。Watcher 的两个参数： expOrFn最终会被转换为 getter 函数， cb是更新时执行的回调。依赖收集的入口就是get函数。<br><figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">constructor</span>(</div><div class="line">    vm: Component,</div><div class="line">    expOrFn: string | Function,</div><div class="line">    cd: Function,</div><div class="line">    options?: Object</div><div class="line">)&#123;</div><div class="line">    <span class="keyword">this</span>.vm = vm</div><div class="line">    vm._watchers.push(<span class="keyword">this</span>) <span class="comment">// 讲当前watcher类推送到对应的Vue实例中</span></div><div class="line">    <span class="comment">// parse expression for getter</span></div><div class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> expOrFn === <span class="string">'function'</span>) &#123;</div><div class="line">        <span class="comment">// 如果是函数，相当于指定了当前订阅者获取数据的方法，每次订阅者通过这个方法获取数据与之前的值进行对比</span></div><div class="line">        <span class="keyword">this</span>.getter = expOrFn</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        <span class="comment">// 否则的话将表达式解析为可执行的函数</span></div><div class="line">        <span class="keyword">this</span>.getter = parsePath(expOrFn)</div><div class="line">    &#125;</div><div class="line">    <span class="comment">// 如果lazy不为true，则执行get函数进行依赖收集</span></div><div class="line">    <span class="keyword">this</span>.value = <span class="keyword">this</span>.lazy ? <span class="literal">undefined</span>: <span class="keyword">this</span>.get()</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>只有通过watcher 触发的getter会收集依赖，而所谓的被收集的依赖就是当前watcher.初始化时传入的参数 expOrFn中涉及到的每一项数据，然后触发该数据项的 getter函数；getter 函数中就是通过判断 Dep.target的有无来判断是Watcher 初始化时调用的还是普通数据读取，如果有则进行依赖收集。<br>getter 函数是用来连接监控属性与 Watcher 的关键。<br><figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">get () &#123;</div><div class="line">    <span class="comment">// 设置全局变量Dep.target,将Watcher保存在这个全局变量中</span></div><div class="line">    pushTarget(<span class="keyword">this</span>)</div><div class="line">    <span class="comment">// 调用getter函数，进入get方法进行依赖收集操作</span></div><div class="line">    <span class="keyword">const</span> value = <span class="keyword">this</span>.getter.call(<span class="keyword">this</span>.vm, <span class="keyword">this</span>.vm)</div><div class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.deep) &#123;</div><div class="line">        traverse(value)</div><div class="line">    &#125;</div><div class="line">    popTarget() <span class="comment">// 将全局变量Dep.target置为null</span></div><div class="line">    <span class="keyword">this</span>.cleanupDeps()</div><div class="line">    <span class="keyword">return</span> value</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="Dep"><a href="#Dep" class="headerlink" title="Dep"></a>Dep</h3><p>src/core/observer/dep.js<br>这个方法是在响应式的过程中调用<br>的，用户修改数据触发 setter 函数，调用 dep.notify 去通<br>知订阅者更新视图。<br><figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">constructor</span> () &#123;</div><div class="line">    <span class="keyword">this</span>.id = uid++</div><div class="line">    <span class="comment">// 存储Watcher实例数组</span></div><div class="line">    <span class="keyword">this</span>.subs = []</div><div class="line">&#125;</div><div class="line"></div><div class="line">notify () &#123;</div><div class="line">    <span class="keyword">const</span> subs = <span class="keyword">this</span>.subs.slice()</div><div class="line">    <span class="comment">// 遍历Watcher列表，调用update方法进行更新操作</span></div><div class="line">    <span class="keyword">for</span>(<span class="keyword">let</span> i = <span class="number">0</span>, l = subs.length; i &lt; l; i++) &#123;</div><div class="line">        subs[i].update()</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="Directive"><a href="#Directive" class="headerlink" title="Directive"></a>Directive</h3><p><img src="http://p1cbbowoo.bkt.clouddn.com/%E5%BE%AE%E4%BF%A1%E5%9B%BE%E7%89%87_20180402153924.png" alt="image"><br>关于编译这块vue分了两种类型，一种是文本节点，一种是元素节点.<br>vue内置了这么多的指令，这些指令都会抛出两个接口bind 和 update，这两个接口的作用是，编译的最后一步是执行所有用到的指令的bind方法，而update 方法则是当watcher 触发 update 时，Directive会触发指令的update方法<br>observe -&gt; 触发setter -&gt;watcher -&gt; 触发update -&gt;Directive -&gt; 触发update -&gt;指令<br><figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// hello &#123;&#123;name&#125;&#125;</span></div><div class="line">[&#123;</div><div class="line">    value: <span class="string">'hello'</span></div><div class="line">&#125;, &#123;</div><div class="line">    value: <span class="string">'name'</span>,</div><div class="line">    tag: <span class="literal">true</span>,</div><div class="line">    html: <span class="literal">false</span>,</div><div class="line">    oneTime: <span class="literal">false</span>,</div><div class="line">    descriptor: &#123;</div><div class="line">        def: &#123;</div><div class="line">            update: <span class="function"><span class="keyword">function</span>,</span></div><div class="line"><span class="function">            <span class="title">bind</span>: <span class="title">function</span></span></div><div class="line"><span class="function">        &#125;,</span></div><div class="line"><span class="function">        <span class="title">expression</span>: <span class="title">xx</span>,</span></div><div class="line"><span class="function">        <span class="title">filters</span>: <span class="title">xx</span>,</span></div><div class="line"><span class="function">        <span class="title">name</span>: '<span class="title">text</span>'</span></div><div class="line"><span class="function">    &#125;</span></div><div class="line"><span class="function">    </span></div><div class="line"><span class="function">&#125;]</span></div></pre></td></tr></table></figure></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">this</span>._directives.push(<span class="keyword">new</span> Directive(descriptor, <span class="keyword">this</span>, node, host, scope, frag))</div></pre></td></tr></table></figure>
<ol>
<li>所有 tag 为 true的数据中的扩展对象拿出来生成一个Directive实例并添加到_directives中（_directives是当前vm中存储所有directive实例的地方）</li>
<li>调用所有已绑定的指令的 bind 方法</li>
<li>实例化一个Watcher，将指令的update与watcher绑定在一起（这样就实现了watcher<br>接收到消息后触发的update方法，指令可以做出对应的更新视图操作）</li>
<li>调用指令的update，首次初始化视图</li>
<li>这里有一个点需要注意一下，实例化 Watcher 的时候，Watcher会将自己主动的推<br>入Dep依赖中</li>
</ol>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p><img src="http://p1cbbowoo.bkt.clouddn.com/%E5%BE%AE%E4%BF%A1%E5%9B%BE%E7%89%87_20180402153929.png" alt="image"></p>
<h1 id="Virtual-dom"><a href="#Virtual-dom" class="headerlink" title="Virtual dom"></a>Virtual dom</h1><p>DOM操作很慢是两个原因，一个是本身操作就不快，第二是我们（还有很多框架）处理dom的方式很慢，Virtual Dom解决了我们这些愚蠢的程序员对Dom的低劣操作，它让我们不需要进行Dom操作，而是将希望展现的最终结果告诉Vue，Vue通过一个简化的Dom即Virtual dom进行render，当你试图改变显示内容时，新生成的Virtual Dom会与现在的Virtual<br>dom对比，通过diff算法找到区别，这些操作都是在快速的js中完成的，最后对实际Dom进行最小的Dom操作来完成效果，这就是Virtual Dom的概念。<br><img src="http://p1cbbowoo.bkt.clouddn.com/%E5%BE%AE%E4%BF%A1%E5%9B%BE%E7%89%87_20180402162223.png" alt="image"><br>这仅仅是第一层。真正的 DOM元素非常庞大，这是因为标准就是这么设计的。而且操作它们的时候你要小心翼翼，轻微的触碰可能就会导致页面重排，这就是杀死性能的罪魁祸首。<br>‘Virtual-dom’是一系列的模块集合，用来提供声明式的DOM渲染。来看一个简单的 DOM 片段.<br>本质上就是在 JS 和 DOM 之间做了一个缓存。可以类比 CPU 和硬盘，既然硬盘这么慢，我<br>们就在它们之间加个缓存：既然 DOM 这么慢，我们就在它们 JS 和 DOM 之间加个缓存。CPU<br>（JS）只操作内存（Virtual DOM），最后的时候再把变更写入硬盘（DOM）。</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"parent"</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">"child"</span>&gt;</span>item1<span class="tag">&lt;/<span class="name">span</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">"child"</span>&gt;</span>item2<span class="tag">&lt;/<span class="name">span</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">"child"</span>&gt;</span>item3<span class="tag">&lt;/<span class="name">span</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></div></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">const</span> dom = &#123;</div><div class="line">    tagName: <span class="string">'div'</span>,</div><div class="line">    props: &#123;</div><div class="line">        id: <span class="string">'parent'</span></div><div class="line">    &#125;,</div><div class="line">    children: [</div><div class="line">        &#123;<span class="attr">tagName</span>: <span class="string">'span'</span>, <span class="attr">props</span>: &#123;<span class="attr">class</span>: <span class="string">'child'</span>&#125;, <span class="attr">children</span>: [<span class="string">'item1'</span>]&#125;,</div><div class="line">        &#123;<span class="attr">tagName</span>: <span class="string">'span'</span>, <span class="attr">props</span>: &#123;<span class="attr">class</span>: <span class="string">'child'</span>&#125;, <span class="attr">children</span>: [<span class="string">'item2'</span>]&#125;,</div><div class="line">        &#123;<span class="attr">tagName</span>: <span class="string">'span'</span>, <span class="attr">props</span>: &#123;<span class="attr">class</span>: <span class="string">'child'</span>&#125;, <span class="attr">children</span>: [<span class="string">'item3'</span>]&#125;</div><div class="line">    ]</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h1 id="Dom-diff"><a href="#Dom-diff" class="headerlink" title="Dom diff"></a>Dom diff</h1><p>比较两棵DOM树的差异是 Virtual DOM算法最核心的部分，这也是所谓的 Virtual DOM 的 diff 算法。两个树的完全的 diff 算法是一个时间复杂度为 O(n^3)的问题。但是在前端当中，你很少会跨越层级地移动DOM元素。所以 Virtual DOM 只会对同一个层级的元素进行对比。下面的div只会和同一层级的div对比，第二层级的只会跟第二层级对比。这样算法复杂度就可以达到 O(n)。<br><img src="http://p1cbbowoo.bkt.clouddn.com/%E5%BE%AE%E4%BF%A1%E5%9B%BE%E7%89%87_20180402164259.png" alt="image"><br>实际的代码中，会对新旧两棵树进行一个深度优先的遍历，这样每个节点都会有一个唯一的标记，在深度优先遍历的时候，每遍历到一个节点就把该节点和新的的树进行对比。如果有差异的话就记录到一个对象里面。p是patches[1]，ul是patches[3]，类推。<br><img src="http://p1cbbowoo.bkt.clouddn.com/%E5%BE%AE%E4%BF%A1%E5%9B%BE%E7%89%87_20180402164303.png" alt="image"></p>
<p>节点的差异指的是什么呢？对 DOM 操作可能会：</p>
<ul>
<li>替换掉原来的节点</li>
<li>移动、删除、新增子节点</li>
<li>修改了节点的属性</li>
<li>对于文本节点，文本内容可能会改变</li>
</ul>
<p>如果我们把全部顺序都换了呢，这就悲剧了全部要删除在加（列表对比算法）：</p>
<ul>
<li>a b c d e f g h i</li>
<li>a b c h d f g i j</li>
<li>这个问题抽象出来其实是字符串的最小编辑距离问题（Edition Distance），最常见的解决算法是 Levenshtein Distance，通过动态规划求解，时间复杂度为 O(M * N)。但是我们并不需要真的达到最小的操作，我们只需要优化一些比较常见的移动情况，牺牲一定DOM操作，让算法时间复杂度达到线性的（O(max(M, N))。</li>
<li>因为tagName是可重复的，不能用这个来进行对比。所以需要给子节点加上唯一标识key，就迎刃而解了。</li>
<li>通过深度优先遍历两棵树，每层的节点进行对比，记录下每个节点的差异了。</li>
<li>JavaScript 对象树和render出来真正的DOM树的信息、结构是一样的。所以我们<br>可以对那棵DOM树也进行深度优先的遍历，遍历的时候从步骤二生成的patches对象中找出当前遍历的节点差异，然后进行 DOM 操作。</li>
</ul>
<p>一些需要注意的点：</p>
<ul>
<li>尽量不要跨层级的修改dom</li>
<li>设置key可以最大化的利用节点</li>
<li>不要盲目相信diff的效率，在必要时可以手工优化</li>
</ul>
<p>一些非常有用的库：</p>
<ul>
<li>core/vdom/create-element.js</li>
<li>core/vdom/patch.js</li>
<li>实现patch <a href="https://github.com/snabbdom/snabbdom" target="_blank" rel="external">https://github.com/snabbdom/snabbdom</a></li>
<li>实现diff <a href="https://github.com/snabbdom/snabbdom" target="_blank" rel="external">https://github.com/snabbdom/snabbdom</a></li>
<li>简陋版 <a href="https://github.com/livoras/simple-virtualdom/blob/master/lib/diff.js" target="_blank" rel="external">https://github.com/livoras/simple-virtualdom/blob/master/lib/diff.js</a></li>
<li>简陋版 <a href="https://github.com/livoras/simple-virtualdom/blob/master/lib/patch.js" target="_blank" rel="external">https://github.com/livoras/simple-virtualdom/blob/master/lib/patch.js</a></li>
</ul>
<h1 id="vue运行时优化"><a href="#vue运行时优化" class="headerlink" title="vue运行时优化"></a>vue运行时优化</h1><ul>
<li>对于不变的内容，标记出来，不做dom diff<br><img src="http://p1cbbowoo.bkt.clouddn.com/%E5%BE%AE%E4%BF%A1%E5%9B%BE%E7%89%87_20180402171141.png" alt="image"></li>
<li>对于不变的数据，直接生成，不做dom diff<br><img src="http://p1cbbowoo.bkt.clouddn.com/%E5%BE%AE%E4%BF%A1%E5%9B%BE%E7%89%87_20180402171147.png" alt="image"><br><img src="http://p1cbbowoo.bkt.clouddn.com/%E5%BE%AE%E4%BF%A1%E5%9B%BE%E7%89%87_20180402171153.png" alt="image"></li>
<li>SSR采用直出字符串拼接的方式，根本不需要dom-diff<br><img src="http://p1cbbowoo.bkt.clouddn.com/%E5%BE%AE%E4%BF%A1%E5%9B%BE%E7%89%87_20180402171157.png" alt="image"></li>
<li>ssr异步加载脚本<br><img src="http://p1cbbowoo.bkt.clouddn.com/%E5%BE%AE%E4%BF%A1%E5%9B%BE%E7%89%87_20180402171637.png" alt="image"></li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2018/02/24/vue源码解析/" data-id="cjjsbiwej001ys3uhnr5emnl1" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/vue/">vue</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2018/03/08/nodejs深入学习笔记/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          nodejs深入学习笔记
        
      </div>
    </a>
  
  
    <a href="/2018/02/01/nginx反向代理和负载均衡/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">nginx反向代理和负载均衡</div>
    </a>
  
</nav>

  
</article>

</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/前端/">前端</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/微信开发/">微信开发</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/服务器/">服务器</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/css/">css</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/http/">http</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/javascript/">javascript</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/js/">js</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/nginx/">nginx</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ngrok/">ngrok</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/node/">node</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/vue/">vue</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/vue-cli/">vue-cli</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/webpack/">webpack</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/跨域/">跨域</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/css/" style="font-size: 13.33px;">css</a> <a href="/tags/http/" style="font-size: 10px;">http</a> <a href="/tags/javascript/" style="font-size: 20px;">javascript</a> <a href="/tags/js/" style="font-size: 16.67px;">js</a> <a href="/tags/nginx/" style="font-size: 10px;">nginx</a> <a href="/tags/ngrok/" style="font-size: 10px;">ngrok</a> <a href="/tags/node/" style="font-size: 10px;">node</a> <a href="/tags/vue/" style="font-size: 10px;">vue</a> <a href="/tags/vue-cli/" style="font-size: 10px;">vue-cli</a> <a href="/tags/webpack/" style="font-size: 13.33px;">webpack</a> <a href="/tags/跨域/" style="font-size: 10px;">跨域</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/07/">July 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/04/">April 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/03/">March 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/02/">February 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/01/">January 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/12/">December 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/11/">November 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/10/">October 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/09/">September 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/08/">August 2017</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2018/07/19/test/">travis-ci</a>
          </li>
        
          <li>
            <a href="/2018/04/01/webpack深入学习/">webpack深入学习</a>
          </li>
        
          <li>
            <a href="/2018/03/08/nodejs深入学习笔记/">nodejs深入学习笔记</a>
          </li>
        
          <li>
            <a href="/2018/02/24/vue源码解析/">vue源码解析</a>
          </li>
        
          <li>
            <a href="/2018/02/01/nginx反向代理和负载均衡/">nginx反向代理和负载均衡</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2018 DogJun<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>

  </div>
</body>
</html>